<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Overhead Ratio Visual Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.min.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <header class="sidebar__header">
        <div>
          <h1>Overhead Ratio Visual Builder</h1>
          <p>Create the ratio graphic with icons above and below the line.</p>
        </div>
        <button class="ghost" id="clearDraft" type="button">Clear Local Draft</button>
      </header>

      <section class="card">
        <h2>Above the Line Counts</h2>
        <p class="card__hint">Choose how many images appear in each category above the line.</p>
        <div class="grid grid--counts">
          <label class="field">
            <span>Manufacturing OMR</span>
            <input type="number" min="0" value="3" id="count-manufacturing">
          </label>
          <label class="field">
            <span>Install OMR</span>
            <input type="number" min="0" value="3" id="count-install">
          </label>
          <label class="field">
            <span>Engineering</span>
            <input type="number" min="0" value="3" id="count-engineering">
          </label>
          <label class="field">
            <span>PL&amp;F</span>
            <input type="number" min="0" value="2" id="count-plf">
          </label>
          <label class="field">
            <span>Safety</span>
            <input type="number" min="0" value="2" id="count-safety">
          </label>
          <label class="field">
            <span>Rows (above the line)</span>
            <input type="number" min="1" value="1" id="rows-above">
          </label>
        </div>
      </section>

      <section class="card">
        <h2>Below the Line Counts</h2>
        <p class="card__hint">Set the total number of images below the divider.</p>
        <div class="grid grid--counts">
          <label class="field">
            <span>Manufacturing &amp; Install Engineers</span>
            <input type="number" min="0" value="10" id="count-below">
          </label>
          <label class="field">
            <span>Rows (below the line)</span>
            <input type="number" min="1" value="2" id="rows-below">
          </label>
        </div>
      </section>

      <section class="card">
        <h2>Labels</h2>
        <p class="card__hint">Edit the text shown above the images and below the line.</p>
        <div class="grid grid--counts">
          <label class="field">
            <span>Manufacturing OMR label</span>
            <input type="text" value="Manufacturing OMR" id="label-manufacturing">
          </label>
          <label class="field">
            <span>Install OMR label</span>
            <input type="text" value="Install OMR" id="label-install">
          </label>
          <label class="field">
            <span>Engineering label</span>
            <input type="text" value="Engineering" id="label-engineering">
          </label>
          <label class="field">
            <span>PL&amp;F label</span>
            <input type="text" value="PL&amp;F" id="label-plf">
          </label>
          <label class="field">
            <span>Safety label</span>
            <input type="text" value="Safety" id="label-safety">
          </label>
          <label class="field">
            <span>Below the line label</span>
            <input type="text" value="Manufacturing &amp; Install Engineers" id="label-below">
          </label>
        </div>
      </section>

      <section class="card">
        <h2>Image Library</h2>
        <p class="card__hint">Upload a distinct image for each category. The legend updates automatically.</p>
        <div class="grid grid--uploads">
          <label class="upload">
            <span>Manufacturing OMR</span>
            <input type="file" accept="image/*" id="img-manufacturing">
            <div class="preview" id="preview-manufacturing"></div>
          </label>
          <label class="upload">
            <span>Install OMR</span>
            <input type="file" accept="image/*" id="img-install">
            <div class="preview" id="preview-install"></div>
          </label>
          <label class="upload">
            <span>Engineering</span>
            <input type="file" accept="image/*" id="img-engineering">
            <div class="preview" id="preview-engineering"></div>
          </label>
          <label class="upload">
            <span>PL&amp;F</span>
            <input type="file" accept="image/*" id="img-plf">
            <div class="preview" id="preview-plf"></div>
          </label>
          <label class="upload">
            <span>Safety</span>
            <input type="file" accept="image/*" id="img-safety">
            <div class="preview" id="preview-safety"></div>
          </label>
          <label class="upload">
            <span>Below the Line</span>
            <input type="file" accept="image/*" id="img-below">
            <div class="preview" id="preview-below"></div>
          </label>
        </div>
      </section>

      <section class="card">
        <h2>Actions</h2>
        <div class="actions">
          <button id="generate" type="button">Generate Figure</button>
          <button id="exportPpt" class="secondary" type="button">Export to PowerPoint</button>
        </div>
      </section>
    </aside>

    <main class="preview-pane">
      <header class="preview-pane__header">
        <h2>Live Output</h2>
        <p>Aligned layout rendered from your settings.</p>
      </header>
      <section class="figure" id="figure">
        <div class="figure__above" id="figure-above"></div>
        <div class="figure__line"></div>
        <div class="figure__below" id="figure-below"></div>
        <div class="figure__caption">Manufacturing &amp; Install Engineers</div>
      </section>
    </main>
  </div>

  <script>
    const categories = [
      { key: 'manufacturing', label: 'Manufacturing OMR' },
      { key: 'install', label: 'Install OMR' },
      { key: 'engineering', label: 'Engineering' },
      { key: 'plf', label: 'PL&F' },
      { key: 'safety', label: 'Safety' }
    ];

    const defaultSvg = encodeURIComponent(`
      <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
        <rect width="120" height="120" rx="18" fill="#EEF2F7" />
        <path d="M35 70c0-12 10-22 22-22s22 10 22 22" stroke="#B3BCCB" stroke-width="6" fill="none"/>
        <circle cx="57" cy="42" r="14" fill="#B3BCCB"/>
      </svg>
    `);

    const state = {
      images: {
        manufacturing: `data:image/svg+xml,${defaultSvg}`,
        install: `data:image/svg+xml,${defaultSvg}`,
        engineering: `data:image/svg+xml,${defaultSvg}`,
        plf: `data:image/svg+xml,${defaultSvg}`,
        safety: `data:image/svg+xml,${defaultSvg}`,
        below: `data:image/svg+xml,${defaultSvg}`
      }
    };

    const draftKey = 'overhead-ratio-draft-v1';

    const saveDraft = () => {
      const draft = {
        counts: {
          manufacturing: document.getElementById('count-manufacturing').value,
          install: document.getElementById('count-install').value,
          engineering: document.getElementById('count-engineering').value,
          plf: document.getElementById('count-plf').value,
          safety: document.getElementById('count-safety').value,
          below: document.getElementById('count-below').value,
          rowsAbove: document.getElementById('rows-above').value,
          rowsBelow: document.getElementById('rows-below').value
        },
        labels: {
          manufacturing: document.getElementById('label-manufacturing').value,
          install: document.getElementById('label-install').value,
          engineering: document.getElementById('label-engineering').value,
          plf: document.getElementById('label-plf').value,
          safety: document.getElementById('label-safety').value,
          below: document.getElementById('label-below').value
        },
        images: state.images
      };
      localStorage.setItem(draftKey, JSON.stringify(draft));
    };

    const loadDraft = () => {
      const raw = localStorage.getItem(draftKey);
      if (!raw) return;
      try {
        const draft = JSON.parse(raw);
        if (draft?.counts) {
          document.getElementById('count-manufacturing').value = draft.counts.manufacturing ?? 0;
          document.getElementById('count-install').value = draft.counts.install ?? 0;
          document.getElementById('count-engineering').value = draft.counts.engineering ?? 0;
          document.getElementById('count-plf').value = draft.counts.plf ?? 0;
          document.getElementById('count-safety').value = draft.counts.safety ?? 0;
          document.getElementById('count-below').value = draft.counts.below ?? 0;
          document.getElementById('rows-above').value = draft.counts.rowsAbove ?? 1;
          document.getElementById('rows-below').value = draft.counts.rowsBelow ?? 2;
        }
        if (draft?.labels) {
          document.getElementById('label-manufacturing').value = draft.labels.manufacturing ?? 'Manufacturing OMR';
          document.getElementById('label-install').value = draft.labels.install ?? 'Install OMR';
          document.getElementById('label-engineering').value = draft.labels.engineering ?? 'Engineering';
          document.getElementById('label-plf').value = draft.labels.plf ?? 'PL&F';
          document.getElementById('label-safety').value = draft.labels.safety ?? 'Safety';
          document.getElementById('label-below').value = draft.labels.below ?? 'Manufacturing & Install Engineers';
        }
        if (draft?.images) {
          state.images = { ...state.images, ...draft.images };
        }
      } catch (error) {
        console.warn('Draft load failed', error);
      }
    };

    const updatePreviewImage = (key, dataUrl) => {
      const preview = document.getElementById(`preview-${key}`);
      preview.style.backgroundImage = `url(${dataUrl})`;
    };

    const initUploads = () => {
      const uploadKeys = [...categories.map((c) => c.key), 'below'];
      uploadKeys.forEach((key) => {
        const input = document.getElementById(`img-${key}`);
        if (!input) return;
        input.addEventListener('change', (event) => {
          const file = event.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (loadEvent) => {
            const result = loadEvent.target.result;
            state.images[key] = result;
            updatePreviewImage(key, result);
            saveDraft();
          };
          reader.readAsDataURL(file);
        });
      });
    };

    const renderLegend = () => {
      categories.forEach((category) => {
        updatePreviewImage(category.key, state.images[category.key]);
      });
      updatePreviewImage('below', state.images.below);
    };

    const createIcon = (src, label) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'icon-card';
      const img = document.createElement('img');
      img.src = src;
      img.alt = label;
      wrapper.appendChild(img);
      return wrapper;
    };

    const getLabelValue = (key) => {
      const input = document.getElementById(`label-${key}`);
      return input?.value?.trim() || categories.find((category) => category.key === key)?.label || key;
    };

    const getRowsValue = (key) => {
      const input = document.getElementById(key);
      return Math.max(1, Number(input?.value || 1));
    };

    const buildIconRows = (count, rows, iconSrc, label, fillFromBottom) => {
      const safeRows = Math.max(1, rows);
      const iconsPerRow = Math.max(1, Math.ceil(count / safeRows));
      const rowElements = Array.from({ length: safeRows }, () => {
        const row = document.createElement('div');
        row.className = 'figure__icon-row';
        return row;
      });

      for (let i = 0; i < count; i += 1) {
        const baseRow = Math.floor(i / iconsPerRow);
        const rowIndex = fillFromBottom ? safeRows - 1 - baseRow : baseRow;
        rowElements[rowIndex].appendChild(createIcon(iconSrc, label));
      }

      return rowElements;
    };

    const renderAbove = () => {
      const container = document.getElementById('figure-above');
      container.innerHTML = '';
      const rowsAbove = getRowsValue('rows-above');

      categories.forEach((category) => {
        const column = document.createElement('div');
        column.className = 'figure__column';

        const title = document.createElement('div');
        title.className = 'figure__column-title';
        const label = getLabelValue(category.key);
        title.textContent = label;
        column.appendChild(title);

        const count = Number(document.getElementById(`count-${category.key}`).value || 0);
        const iconGrid = document.createElement('div');
        iconGrid.className = 'figure__icon-grid';
        const iconRows = buildIconRows(count, rowsAbove, state.images[category.key], label, true);
        iconRows.forEach((row) => iconGrid.appendChild(row));

        column.appendChild(iconGrid);
        container.appendChild(column);
      });
    };

    const renderBelow = () => {
      const container = document.getElementById('figure-below');
      container.innerHTML = '';

      const count = Number(document.getElementById('count-below').value || 0);
      const rowsBelow = getRowsValue('rows-below');
      const labelInput = document.getElementById('label-below');
      const label = labelInput?.value?.trim() || 'Below the line';
      const iconRows = buildIconRows(count, rowsBelow, state.images.below, label, false);
      iconRows.forEach((row) => container.appendChild(row));
      document.querySelector('.figure__caption').textContent = label;
    };

    const renderFigure = () => {
      renderAbove();
      renderBelow();
      saveDraft();
    };

    const exportToPpt = () => {
      const pptx = new PptxGenJS();
      pptx.layout = 'LAYOUT_WIDE';

      const slide = pptx.addSlide();
      slide.addText('Overhead Ratio Visual', { x: 0.6, y: 0.2, w: 12.3, h: 0.4, fontSize: 18, bold: true, color: '1F2933' });

      const slideWidth = 13.3;
      const leftPadding = 0.6;
      const rightPadding = 0.6;
      const usableWidth = slideWidth - leftPadding - rightPadding;
      const columnWidth = usableWidth / categories.length;
      const iconSize = 0.7;
      const iconGap = 0.1;
      const aboveRows = getRowsValue('rows-above');
      const belowRows = getRowsValue('rows-below');
      const lineY = 3.4;
      const aboveBottomPadding = 0.2;
      const belowTopPadding = 0.3;
      const aboveRowHeight = aboveRows * (iconSize + iconGap) - iconGap;
      const aboveIconsTop = lineY - aboveBottomPadding - aboveRowHeight;

      categories.forEach((category, index) => {
        const columnX = leftPadding + columnWidth * index;
        const label = getLabelValue(category.key);
        slide.addText(label, {
          x: columnX,
          y: 0.8,
          w: columnWidth,
          h: 0.3,
          fontSize: 12,
          align: 'center',
          color: '4B5563'
        });

        const count = Number(document.getElementById(`count-${category.key}`).value || 0);
        const iconsPerRow = Math.max(1, Math.ceil(count / aboveRows));
        for (let i = 0; i < count; i += 1) {
          const row = aboveRows - 1 - Math.floor(i / iconsPerRow);
          const col = i % iconsPerRow;
          const x = columnX + col * (iconSize + iconGap) + (columnWidth - iconsPerRow * (iconSize + iconGap) + iconGap) / 2;
          const y = aboveIconsTop + row * (iconSize + iconGap);
          slide.addImage({ data: state.images[category.key], x, y, w: iconSize, h: iconSize });
        }
      });

      slide.addShape(pptx.ShapeType.line, {
        x: leftPadding,
        y: lineY,
        w: usableWidth,
        h: 0,
        line: { color: '111827', width: 2 }
      });

      const belowCount = Number(document.getElementById('count-below').value || 0);
      const belowIconsPerRow = Math.max(1, Math.ceil(belowCount / belowRows));
      for (let i = 0; i < belowCount; i += 1) {
        const row = Math.floor(i / belowIconsPerRow);
        const col = i % belowIconsPerRow;
        const x = leftPadding + col * (iconSize + iconGap);
        const y = lineY + belowTopPadding + row * (iconSize + iconGap);
        slide.addImage({ data: state.images.below, x, y, w: iconSize, h: iconSize });
      }

      const belowLabel = document.getElementById('label-below').value?.trim() || 'Manufacturing & Install Engineers';
      slide.addText(belowLabel, {
        x: leftPadding,
        y: 6.5,
        w: usableWidth,
        h: 0.4,
        fontSize: 12,
        align: 'center',
        color: '4B5563'
      });

      pptx.writeFile({ fileName: 'overhead-ratio-visual.pptx' });
    };

    document.getElementById('generate').addEventListener('click', renderFigure);
    document.getElementById('exportPpt').addEventListener('click', exportToPpt);
    document.getElementById('clearDraft').addEventListener('click', () => {
      localStorage.removeItem(draftKey);
      window.location.reload();
    });

    document.querySelectorAll('input[type="number"], input[type="text"]').forEach((input) => {
      input.addEventListener('input', () => {
        renderFigure();
      });
    });

    loadDraft();
    initUploads();
    renderLegend();
    renderFigure();
  </script>
</body>
</html>
