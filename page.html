<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Overhead Ratio Visual Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: light;
      font-family: "Inter", "Segoe UI", sans-serif;
      --bg: #eef2f7;
      --card: #ffffff;
      --text: #1f2933;
      --muted: #6b7280;
      --border: #dde3ee;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --accent-soft: #e0edff;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: linear-gradient(180deg, #f7f9fd 0%, var(--bg) 100%);
      color: var(--text);
      min-height: 100vh;
    }

    h1,
    h2,
    p {
      margin: 0;
    }

    .app {
      display: grid;
      grid-template-columns: minmax(320px, 420px) minmax(0, 1fr);
      gap: 24px;
      padding: 24px;
      height: 100vh;
      max-width: 1440px;
      margin: 0 auto;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .sidebar__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .sidebar__header h1 {
      font-size: 20px;
      font-weight: 700;
    }

    .sidebar__header p {
      font-size: 14px;
      color: var(--muted);
      margin-top: 6px;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.6);
      pointer-events: none;
    }

    .card h2 {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .card__header h2 {
      margin-bottom: 0;
      font-weight: 600;
    }

    .card__header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card__hint {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .card__body {
      display: grid;
      gap: 12px;
    }

    .card__body[hidden] {
      display: none;
    }

    .card__toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #dbe3f1;
      background: #f1f5ff;
      color: var(--text);
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
      transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .card__toggle:hover {
      background: #e0edff;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12);
    }

    .card__toggle:active {
      transform: translateY(1px);
    }

    .card__toggle-icon {
      width: 12px;
      height: 12px;
      border: 1.5px solid currentColor;
      border-top: 0;
      border-left: 0;
      transform: rotate(45deg);
      transition: transform 0.2s ease;
      margin-top: -2px;
    }

    .card__toggle[aria-expanded="false"] .card__toggle-icon {
      transform: rotate(-135deg);
      margin-top: 2px;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .grid--uploads {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .grid--products {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .counts-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .counts-table th,
    .counts-table td {
      text-align: left;
      padding: 4px 6px;
      vertical-align: top;
    }

    .counts-table thead th {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .counts-table td {
      text-align: right;
    }

    .counts-table__label {
      display: block;
      font-size: 13px;
      line-height: 1.2;
      color: var(--text);
      word-break: break-word;
    }

    .counts-table__input {
      width: 72px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      text-align: right;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .counts-table__input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .field--row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 12px;
      padding: 4px 6px;
    }

    .field span {
      min-height: 32px;
      display: flex;
      align-items: center;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .field input {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .field input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    .field--row input {
      width: 72px;
      text-align: right;
    }

    .counts-divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0 8px;
    }

    .upload {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: #f5f7fb;
    }

    .upload__header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upload__label {
      flex: 1 1 140px;
      min-width: 0;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
      height: 32px;
    }

    .upload__select {
      width: 100%;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
      height: 32px;
      background: #fff;
    }

    .upload__custom {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      background: #fff;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px;
    }

    .upload__file {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .upload__file-label {
      font-size: 11px;
      color: var(--muted);
    }

    .upload input[type="file"] {
      font-size: 12px;
    }

    .upload__footer {
      display: flex;
      width: 100%;
    }

    .upload__footer button {
      width: 100%;
    }

    .preview {
      height: 80px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background-color: #f9fafb;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .preview--dual {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      padding: 8px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .preview__item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .preview__icon {
      width: 48px;
      height: 48px;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .actions__export {
      display: grid;
      gap: 8px;
    }

    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.18);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    button:hover {
      background: var(--accent-strong);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.22);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: #111827;
    }

    button.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 12px;
      box-shadow: none;
    }

    button.ghost--danger {
      color: #b91c1c;
      border-color: #fecaca;
    }

    button.ghost--danger:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .export-status {
      display: none;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .export-status.is-active {
      display: flex;
    }

    .export-status__header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .export-status__message {
      font-weight: 500;
    }

    .export-status__details {
      margin: 0;
      padding-left: 16px;
      font-size: 11px;
      color: #8b95a5;
      display: grid;
      gap: 4px;
    }

    .export-status__bar {
      position: relative;
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .export-status__bar::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(37, 99, 235, 0.2), rgba(37, 99, 235, 0.9), rgba(37, 99, 235, 0.2));
      transform: translateX(-100%);
      animation: export-progress 1.2s infinite;
    }

    @keyframes export-progress {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .preview-pane {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .preview-pane__header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .preview-pane__header h2 {
      font-size: 18px;
    }

    .preview-pane__header p {
      font-size: 13px;
      color: var(--muted);
    }

    .figure {
      background: linear-gradient(180deg, #fffdfa 0%, #f7fafc 100%);
      border-radius: 18px;
      padding: 24px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 600px;
      justify-content: flex-start;
      position: relative;
      overflow: hidden;
    }

    .figure::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(37, 99, 235, 0.06), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(37, 99, 235, 0.04), transparent 40%),
        radial-gradient(circle at 50% 100%, rgba(15, 23, 42, 0.04), transparent 50%);
      z-index: 0;
      pointer-events: none;
    }

    .figure > * {
      position: relative;
      z-index: 1;
    }

    .figure__above {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      align-items: stretch;
      min-height: 0;
      padding-bottom: 4px;
    }

    .figure__column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      height: 100%;
    }

    .figure__column-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      text-align: center;
      min-height: 32px;
      max-width: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
      font-weight: 600;
    }

    .figure__icon-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      align-items: center;
      margin-top: 8px;
    }

    .figure__below .figure__icon-grid {
      margin-top: 0;
    }

    .figure__above .figure__icon-grid {
      flex: 1;
      justify-content: flex-end;
    }

    .figure__icon-row {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .figure__icon-cell {
      width: 64px;
      height: 64px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .figure__icon-cell::before {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(203, 213, 225, 0.8);
      box-shadow: inset 0 1px 4px rgba(148, 163, 184, 0.2);
    }

    .figure__line {
      height: 3px;
      background: linear-gradient(90deg, rgba(17, 24, 39, 0.8), rgba(37, 99, 235, 0.9), rgba(17, 24, 39, 0.8));
      border-radius: 999px;
      margin: 0 8px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
    }

    .figure__below {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      padding-top: 4px;
      align-items: start;
      justify-items: center;
    }

    .figure__below .figure__column-title {
      margin-top: 8px;
    }

    .icon-card {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    .icon-card img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 6px 8px rgba(15, 23, 42, 0.2));
    }

    .icon-card--product-a {
      z-index: 2;
    }

    .icon-card--product-b {
      z-index: 1;
      opacity: 0.85;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .legend__item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f8fafc;
      border: 1px solid var(--border);
    }

    .legend__swatch {
      width: 12px;
      height: 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .legend__swatch--a {
      background: #111827;
    }

    .legend__swatch--b {
      background: #9ca3af;
    }

    @media (max-width: 1100px) {
      .app {
        grid-template-columns: 1fr;
        height: auto;
      }

      .preview-pane {
        min-height: 500px;
      }
    }
  </style>

  <!-- FIX: Load the BROWSER BUNDLE build so writeFile works reliably in GitHub Pages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.bundle.min.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <header class="sidebar__header">
        <div>
          <h1>Overhead Ratio Visual Builder</h1>
          <p>Create the ratio graphic with icons above and below the line.</p>
        </div>
        <button class="ghost" id="clearDraft" type="button">Clear Local Draft</button>
      </header>

      <section class="card">
        <div class="card__header">
          <h2>Product Labels</h2>
          <button class="ghost card__toggle" type="button" aria-expanded="true">
            <span class="card__toggle-label">Collapse</span>
            <span class="card__toggle-icon" aria-hidden="true"></span>
          </button>
        </div>
        <div class="card__body">
          <p class="card__hint">Rename Product A and Product B in the legend, tables, and previews.</p>
          <div class="grid grid--products">
            <label class="field">
              <span>Product A label</span>
              <input type="text" id="product-label-a" value="Product A">
            </label>
            <label class="field">
              <span>Product B label</span>
              <input type="text" id="product-label-b" value="Product B">
            </label>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card__header">
          <h2>Above the Line Counts</h2>
          <button class="ghost card__toggle" type="button" aria-expanded="true">
            <span class="card__toggle-label">Collapse</span>
            <span class="card__toggle-icon" aria-hidden="true"></span>
          </button>
        </div>
        <div class="card__body">
          <p class="card__hint">Choose how many icons appear in each category above the line.</p>
          <div id="counts-above"></div>
          <div class="counts-divider" role="presentation"></div>
          <label class="field field--row">
            <span>Rows (above the line)</span>
            <input type="number" min="1" value="1" id="rows-above">
          </label>
        </div>
      </section>

      <section class="card">
        <div class="card__header">
          <h2>Below the Line Counts</h2>
          <button class="ghost card__toggle" type="button" aria-expanded="true">
            <span class="card__toggle-label">Collapse</span>
            <span class="card__toggle-icon" aria-hidden="true"></span>
          </button>
        </div>
        <div class="card__body">
          <p class="card__hint">Choose how many icons appear in each category below the divider.</p>
          <div id="counts-below"></div>
          <div class="counts-divider" role="presentation"></div>
          <label class="field field--row">
            <span>Rows (below the line)</span>
            <input type="number" min="1" value="2" id="rows-below">
          </label>
        </div>
      </section>

      <section class="card">
        <div class="card__header">
          <h2>Stick Figure Library &amp; Labels</h2>
          <div class="card__header-actions">
            <button class="ghost" id="add-category" type="button">Add Label</button>
            <button class="ghost card__toggle" type="button" aria-expanded="true">
              <span class="card__toggle-label">Collapse</span>
              <span class="card__toggle-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="card__body">
          <p class="card__hint">Choose stick figure icons and edit labels together. Add or remove categories as needed.</p>
          <div class="grid grid--uploads" id="category-library"></div>
        </div>
      </section>

      <section class="card">
        <div class="card__header">
          <h2>Actions</h2>
          <button class="ghost card__toggle" type="button" aria-expanded="true">
            <span class="card__toggle-label">Collapse</span>
            <span class="card__toggle-icon" aria-hidden="true"></span>
          </button>
        </div>
        <div class="card__body">
          <div class="actions">
            <div class="actions__export">
              <button id="exportPpt" class="secondary" type="button">Export to PowerPoint</button>
              <div class="export-status" id="exportStatus">
                <div class="export-status__header">
                  <span class="export-status__message" id="exportStatusMessage">Exportingâ€¦</span>
                  <div class="export-status__bar" role="progressbar" aria-valuetext="Exporting"></div>
                </div>
                <ul class="export-status__details" id="exportStatusDetails"></ul>
              </div>
            </div>
          </div>
        </div>
      </section>
    </aside>

    <main class="preview-pane">
      <header class="preview-pane__header">
        <h2>Live Output</h2>
        <div class="legend">
          <div class="legend__item">
            <span class="legend__swatch legend__swatch--a" aria-hidden="true"></span>
            <span id="legend-label-a">Product A</span>
          </div>
          <div class="legend__item">
            <span class="legend__swatch legend__swatch--b" aria-hidden="true"></span>
            <span id="legend-label-b">Product B</span>
          </div>
        </div>
      </header>
      <section class="figure" id="figure">
        <div class="figure__above" id="figure-above"></div>
        <div class="figure__line"></div>
        <div class="figure__below" id="figure-below"></div>
      </section>
    </main>
  </div>

  <script>
    const svgToDataUrl = (svg) => {
      const encoded = btoa(unescape(encodeURIComponent(svg)));
      return `data:image/svg+xml;base64,${encoded}`;
    };

    const productColors = {
      a: '#111827',
      b: '#9ca3af'
    };

    const defaultProductLabels = {
      a: 'Product A',
      b: 'Product B'
    };

    const iconLibrary = [
      {
        id: 'hard-hat',
        label: 'Hard Hat',
        body: `
          <circle cx="60" cy="60" r="50" fill="none" stroke="{{color}}" stroke-width="6" />
          <circle cx="60" cy="52" r="14" fill="none" stroke="{{color}}" stroke-width="6" />
          <path d="M40 52h40" stroke="{{color}}" stroke-width="6" stroke-linecap="round"/>
          <rect x="52" y="32" width="16" height="10" rx="3" fill="{{color}}" />
          <path d="M34 86c7-14 18-20 26-20s19 6 26 20" stroke="{{color}}" stroke-width="6" stroke-linecap="round" fill="none"/>
          <path d="M44 84v16" stroke="{{color}}" stroke-width="6" stroke-linecap="round"/>
          <path d="M76 84v16" stroke="{{color}}" stroke-width="6" stroke-linecap="round"/>
        `
      },
      {
        id: 'wrench',
        label: 'Wrench Tech',
        body: `
          <circle cx="60" cy="28" r="13" fill="{{color}}" />
          <path d="M60 46v28" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M42 66h36" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M52 102V74" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M68 102V74" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M80 38l14-10" stroke="{{color}}" stroke-width="6" stroke-linecap="round"/>
          <circle cx="98" cy="28" r="5" fill="{{color}}" />
        `
      },
      {
        id: 'gear',
        label: 'Gear Lead',
        body: `
          <circle cx="60" cy="28" r="13" fill="{{color}}" />
          <path d="M60 46v26" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M36 66h48" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M50 102V72" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M70 102V72" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <circle cx="92" cy="60" r="10" stroke="{{color}}" stroke-width="6" fill="none"/>
          <path d="M92 46v6M92 68v6M78 60h6M100 60h6" stroke="{{color}}" stroke-width="5" stroke-linecap="round"/>
        `
      },
      {
        id: 'clipboard',
        label: 'Clipboard',
        body: `
          <circle cx="60" cy="28" r="13" fill="{{color}}" />
          <path d="M60 46v28" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M42 66h36" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M52 102V74" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M68 102V74" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <rect x="86" y="44" width="18" height="26" rx="2" stroke="{{color}}" stroke-width="4" fill="none"/>
          <rect x="90" y="40" width="10" height="6" rx="2" fill="{{color}}" />
        `
      },
      {
        id: 'visor',
        label: 'Safety Visor',
        body: `
          <circle cx="60" cy="30" r="14" fill="{{color}}" />
          <rect x="38" y="18" width="44" height="10" rx="5" fill="{{color}}" />
          <rect x="40" y="30" width="40" height="10" rx="5" stroke="{{color}}" stroke-width="4" fill="none"/>
          <path d="M60 46v32" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M36 68h48" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M50 102V76" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M70 102V76" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
        `
      },
      {
        id: 'toolbox',
        label: 'Toolbox',
        body: `
          <circle cx="60" cy="28" r="13" fill="{{color}}" />
          <path d="M60 46v24" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M40 66h40" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M50 102V72" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <path d="M70 102V72" stroke="{{color}}" stroke-width="8" stroke-linecap="round"/>
          <rect x="82" y="58" width="26" height="16" rx="3" stroke="{{color}}" stroke-width="4" fill="none"/>
          <rect x="90" y="54" width="10" height="6" rx="2" fill="{{color}}" />
        `
      }
    ];
    const defaultCategories = [
      { id: 'manufacturing-omr', label: 'Manufacturing OMR', counts: { above: { a: 3, b: 0 }, below: { a: 0, b: 0 } }, iconId: 'hard-hat' },
      { id: 'install-omr', label: 'Install OMR', counts: { above: { a: 3, b: 0 }, below: { a: 0, b: 0 } }, iconId: 'hard-hat' },
      { id: 'engineering', label: 'Engineering', counts: { above: { a: 3, b: 0 }, below: { a: 0, b: 0 } }, iconId: 'gear' },
      { id: 'plf', label: 'PL&F', counts: { above: { a: 2, b: 0 }, below: { a: 0, b: 0 } }, iconId: 'wrench' },
      { id: 'safety', label: 'Safety', counts: { above: { a: 2, b: 0 }, below: { a: 0, b: 0 } }, iconId: 'hard-hat' },
      { id: 'mfg-install', label: 'Manufacturing & Install Engineers', counts: { above: { a: 0, b: 0 }, below: { a: 10, b: 0 } }, iconId: 'gear' }
    ];

    const state = {
      categories: structuredClone(defaultCategories),
      rowsAbove: 1,
      rowsBelow: 2,
      productLabels: structuredClone(defaultProductLabels)
    };

    const draftKey = 'overhead-ratio-draft-v2';

    const normalizeNumber = (value) => {
      const parsed = Number.parseFloat(value);
      return Number.isFinite(parsed) ? parsed : 0;
    };

    const normalizeCounts = (counts) => {
      const above = counts?.above;
      const below = counts?.below;
      const normalizeSide = (side) => {
        if (typeof side === 'number') {
          return { a: normalizeNumber(side), b: 0 };
        }
        return {
          a: normalizeNumber(side?.a ?? 0),
          b: normalizeNumber(side?.b ?? 0)
        };
      };
      return {
        above: normalizeSide(above),
        below: normalizeSide(below)
      };
    };

    const normalizeCategory = (category) => ({
      id: category.id || `category-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
      label: category.label || 'New Category',
      counts: normalizeCounts(category.counts),
      iconId: iconLibrary.some((icon) => icon.id === category.iconId) ? category.iconId : iconLibrary[0].id,
      customIcons: {
        a: typeof category.customIcons?.a === 'string' ? category.customIcons.a : null,
        b: typeof category.customIcons?.b === 'string' ? category.customIcons.b : null
      }
    });

    const getIconDefinition = (iconId) => iconLibrary.find((icon) => icon.id === iconId) || iconLibrary[0];

    const buildIconSvg = (iconId, color, fraction = 1) => {
      const icon = getIconDefinition(iconId);
      const safeFraction = Math.min(1, Math.max(0, fraction));
      const body = icon.body.replaceAll('{{color}}', color);
      if (safeFraction >= 0.999) {
        return `
          <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
            ${body}
          </svg>
        `;
      }
      const clipHeight = 120 * safeFraction;
      const clipY = 120 - clipHeight;
      return `
        <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <clipPath id="clip">
              <rect x="0" y="${clipY}" width="120" height="${clipHeight}" />
            </clipPath>
          </defs>
          <g clip-path="url(#clip)">
            ${body}
          </g>
        </svg>
      `;
    };

    const getIconDataUrl = (iconId, color, fraction = 1) => svgToDataUrl(buildIconSvg(iconId, color, fraction));

    const buildImageSvg = (imageDataUrl, fraction = 1) => {
      const safeFraction = Math.min(1, Math.max(0, fraction));
      if (safeFraction >= 0.999) {
        return `
          <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
            <image href="${imageDataUrl}" x="0" y="0" width="120" height="120" preserveAspectRatio="xMidYMid meet" />
          </svg>
        `;
      }
      const clipHeight = 120 * safeFraction;
      const clipY = 120 - clipHeight;
      return `
        <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <clipPath id="clip">
              <rect x="0" y="${clipY}" width="120" height="${clipHeight}" />
            </clipPath>
          </defs>
          <g clip-path="url(#clip)">
            <image href="${imageDataUrl}" x="0" y="0" width="120" height="120" preserveAspectRatio="xMidYMid meet" />
          </g>
        </svg>
      `;
    };

    const getCategoryIconDataUrl = (category, productKey, fraction = 1) => {
      const customIcon = category.customIcons?.[productKey];
      if (customIcon) {
        return svgToDataUrl(buildImageSvg(customIcon, fraction));
      }
      return getIconDataUrl(category.iconId, productColors[productKey], fraction);
    };

    const getProductLabel = (key) => state.productLabels?.[key]?.trim() || defaultProductLabels[key];

    const saveDraft = () => {
      const draft = {
        categories: state.categories,
        rowsAbove: state.rowsAbove,
        rowsBelow: state.rowsBelow,
        productLabels: state.productLabels
      };
      localStorage.setItem(draftKey, JSON.stringify(draft));
    };

    const loadDraft = () => {
      const raw = localStorage.getItem(draftKey) || localStorage.getItem('overhead-ratio-draft-v1');
      if (!raw) return;
      try {
        const draft = JSON.parse(raw);
        if (draft?.categories?.length) {
          state.categories = draft.categories.map(normalizeCategory);
          state.rowsAbove = Number(draft.rowsAbove ?? 1);
          state.rowsBelow = Number(draft.rowsBelow ?? 2);
          state.productLabels = {
            a: draft.productLabels?.a ?? defaultProductLabels.a,
            b: draft.productLabels?.b ?? defaultProductLabels.b
          };
          return;
        }

        if (draft?.counts || draft?.labels || draft?.images) {
          const mapped = structuredClone(defaultCategories).map((category) => {
            if (draft?.labels) {
              const labelMap = {
                'manufacturing-omr': draft.labels.manufacturing,
                'install-omr': draft.labels.install,
                engineering: draft.labels.engineering,
                plf: draft.labels.plf,
                safety: draft.labels.safety,
                'mfg-install': draft.labels.below
              };
              category.label = labelMap[category.id] ?? category.label;
            }

            if (draft?.counts) {
              const countMap = {
                'manufacturing-omr': draft.counts.manufacturing,
                'install-omr': draft.counts.install,
                engineering: draft.counts.engineering,
                plf: draft.counts.plf,
                safety: draft.counts.safety,
                'mfg-install': draft.counts.below
              };
              const mappedCount = normalizeNumber(countMap[category.id] ?? 0);
              if (category.id === 'mfg-install') {
                category.counts.below = { a: mappedCount, b: 0 };
              } else {
                category.counts.above = { a: mappedCount, b: 0 };
              }
            }
            return category;
          });

          state.categories = mapped;
          state.rowsAbove = Number(draft.counts?.rowsAbove ?? 1);
          state.rowsBelow = Number(draft.counts?.rowsBelow ?? 2);
        }
        state.productLabels = {
          a: draft.productLabels?.a ?? defaultProductLabels.a,
          b: draft.productLabels?.b ?? defaultProductLabels.b
        };
      } catch (error) {
        console.warn('Draft load failed', error);
      }
    };

    const createIcon = (category, label, productKey, fraction = 1) => {
      const wrapper = document.createElement('div');
      wrapper.className = `icon-card icon-card--product-${productKey}`;
      const img = document.createElement('img');
      img.src = getCategoryIconDataUrl(category, productKey, fraction);
      img.alt = label;
      wrapper.appendChild(img);
      return wrapper;
    };

    const getCategoryLabel = (category) => category.label?.trim() || 'Untitled';

    const getSlotCount = (count) => {
      const safe = Math.max(0, count);
      const whole = Math.floor(safe);
      const fraction = safe - whole;
      return whole + (fraction > 0 ? 1 : 0);
    };

    const getSlotFraction = (count, index) => {
      const safe = Math.max(0, count);
      const whole = Math.floor(safe);
      const fraction = safe - whole;
      if (index < whole) return 1;
      if (index === whole && fraction > 0) return fraction;
      return 0;
    };

    const buildIconRows = (counts, rows, category, label, fillFromBottom) => {
      const safeRows = Math.max(1, rows);
      const slotsA = getSlotCount(counts.a);
      const slotsB = getSlotCount(counts.b);
      const maxSlots = Math.max(slotsA, slotsB);
      const iconsPerRow = Math.max(1, Math.ceil(maxSlots / safeRows));
      const rowElements = Array.from({ length: safeRows }, () => {
        const row = document.createElement('div');
        row.className = 'figure__icon-row';
        return row;
      });

      for (let i = 0; i < maxSlots; i += 1) {
        const baseRow = Math.floor(i / iconsPerRow);
        const rowIndex = fillFromBottom ? safeRows - 1 - baseRow : baseRow;
        const cell = document.createElement('div');
        cell.className = 'figure__icon-cell';

        const fractionA = getSlotFraction(counts.a, i);
        if (fractionA > 0) {
          cell.appendChild(createIcon(category, label, 'a', fractionA));
        }

        const fractionB = getSlotFraction(counts.b, i);
        if (fractionB > 0) {
          cell.appendChild(createIcon(category, label, 'b', fractionB));
        }

        rowElements[rowIndex].appendChild(cell);
      }

      return rowElements;
    };

    const renderCountsSection = (containerId, position) => {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'counts-table';

      const header = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `
        <th>Category</th>
        <th>${getProductLabel('a')}</th>
        <th>${getProductLabel('b')}</th>
      `;
      header.appendChild(headerRow);
      table.appendChild(header);

      const body = document.createElement('tbody');

      state.categories.forEach((category) => {
        const row = document.createElement('tr');
        const labelCell = document.createElement('th');
        const label = document.createElement('span');
        label.className = 'counts-table__label';
        label.textContent = getCategoryLabel(category);
        labelCell.appendChild(label);

        const inputCellA = document.createElement('td');
        const inputA = document.createElement('input');
        inputA.className = 'counts-table__input';
        inputA.type = 'number';
        inputA.min = '0';
        inputA.step = '0.1';
        inputA.value = category.counts[position].a ?? 0;
        inputA.addEventListener('input', () => {
          category.counts[position].a = normalizeNumber(inputA.value || 0);
          renderFigure();
          saveDraft();
        });
        inputCellA.appendChild(inputA);

        const inputCellB = document.createElement('td');
        const inputB = document.createElement('input');
        inputB.className = 'counts-table__input';
        inputB.type = 'number';
        inputB.min = '0';
        inputB.step = '0.1';
        inputB.value = category.counts[position].b ?? 0;
        inputB.addEventListener('input', () => {
          category.counts[position].b = normalizeNumber(inputB.value || 0);
          renderFigure();
          saveDraft();
        });
        inputCellB.appendChild(inputB);

        row.appendChild(labelCell);
        row.appendChild(inputCellA);
        row.appendChild(inputCellB);
        body.appendChild(row);
      });
      table.appendChild(body);
      container.appendChild(table);
    };

    const renderCategoryLibrary = () => {
      const container = document.getElementById('category-library');
      container.innerHTML = '';
      const disableRemove = state.categories.length === 1;

      state.categories.forEach((category) => {
        const card = document.createElement('div');
        card.className = 'upload';

        const header = document.createElement('div');
        header.className = 'upload__header';

        const labelInput = document.createElement('input');
        labelInput.type = 'text';
        labelInput.value = category.label;
        labelInput.className = 'upload__label';
        labelInput.addEventListener('input', () => {
          category.label = labelInput.value;
          renderCountsSection('counts-above', 'above');
          renderCountsSection('counts-below', 'below');
          renderFigure();
          saveDraft();
        });

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'ghost ghost--danger';
        removeButton.textContent = 'Remove';
        removeButton.disabled = disableRemove;
        removeButton.addEventListener('click', () => {
          state.categories = state.categories.filter((item) => item.id !== category.id);
          renderControls();
          renderFigure();
          saveDraft();
        });

        header.appendChild(labelInput);

        const iconSelect = document.createElement('select');
        iconSelect.className = 'upload__select';
        iconLibrary.forEach((icon) => {
          const option = document.createElement('option');
          option.value = icon.id;
          option.textContent = icon.label;
          if (icon.id === category.iconId) option.selected = true;
          iconSelect.appendChild(option);
        });
        iconSelect.addEventListener('change', () => {
          category.iconId = iconSelect.value;
          updatePreview();
          renderFigure();
          saveDraft();
        });

        const customIconWrap = document.createElement('div');
        customIconWrap.className = 'upload__custom';

        const buildCustomField = (productKey) => {
          const field = document.createElement('div');
          field.className = 'upload__file';

          const label = document.createElement('span');
          label.className = 'upload__file-label';
          label.textContent = `${getProductLabel(productKey)} icon`;

          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.addEventListener('change', () => {
            const file = input.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              category.customIcons[productKey] = typeof reader.result === 'string' ? reader.result : null;
              updatePreview();
              renderFigure();
              saveDraft();
            };
            reader.readAsDataURL(file);
          });

          const clearButton = document.createElement('button');
          clearButton.type = 'button';
          clearButton.className = 'ghost';
          clearButton.textContent = 'Clear icon';
          clearButton.addEventListener('click', () => {
            category.customIcons[productKey] = null;
            input.value = '';
            updatePreview();
            renderFigure();
            saveDraft();
          });

          field.appendChild(label);
          field.appendChild(input);
          field.appendChild(clearButton);
          return field;
        };

        customIconWrap.appendChild(buildCustomField('a'));
        customIconWrap.appendChild(buildCustomField('b'));

        const footer = document.createElement('div');
        footer.className = 'upload__footer';
        footer.appendChild(removeButton);

        const preview = document.createElement('div');
        preview.className = 'preview--dual';

        const previewA = document.createElement('div');
        previewA.className = 'preview__item';
        const previewAIcon = document.createElement('img');
        previewAIcon.className = 'preview__icon';
        previewAIcon.alt = `${getProductLabel('a')} preview`;
        const previewALabel = document.createElement('span');
        previewALabel.textContent = getProductLabel('a');
        previewA.appendChild(previewAIcon);
        previewA.appendChild(previewALabel);

        const previewB = document.createElement('div');
        previewB.className = 'preview__item';
        const previewBIcon = document.createElement('img');
        previewBIcon.className = 'preview__icon';
        previewBIcon.alt = `${getProductLabel('b')} preview`;
        const previewBLabel = document.createElement('span');
        previewBLabel.textContent = getProductLabel('b');
        previewB.appendChild(previewBIcon);
        previewB.appendChild(previewBLabel);

        preview.appendChild(previewA);
        preview.appendChild(previewB);

        const updatePreview = () => {
          previewAIcon.src = getCategoryIconDataUrl(category, 'a');
          previewBIcon.src = getCategoryIconDataUrl(category, 'b');
        };
        updatePreview();

        card.appendChild(header);
        card.appendChild(iconSelect);
        card.appendChild(customIconWrap);
        card.appendChild(preview);
        card.appendChild(footer);
        container.appendChild(card);
      });
    };

    const renderControls = () => {
      renderCountsSection('counts-above', 'above');
      renderCountsSection('counts-below', 'below');
      renderCategoryLibrary();

      const productLabelAInput = document.getElementById('product-label-a');
      const productLabelBInput = document.getElementById('product-label-b');
      const legendLabelA = document.getElementById('legend-label-a');
      const legendLabelB = document.getElementById('legend-label-b');

      if (productLabelAInput && productLabelBInput) {
        productLabelAInput.value = getProductLabel('a');
        productLabelBInput.value = getProductLabel('b');
        productLabelAInput.oninput = () => {
          state.productLabels.a = productLabelAInput.value;
          if (legendLabelA) legendLabelA.textContent = getProductLabel('a');
          renderControls();
          renderFigure();
          saveDraft();
        };
        productLabelBInput.oninput = () => {
          state.productLabels.b = productLabelBInput.value;
          if (legendLabelB) legendLabelB.textContent = getProductLabel('b');
          renderControls();
          renderFigure();
          saveDraft();
        };
      }

      if (legendLabelA) legendLabelA.textContent = getProductLabel('a');
      if (legendLabelB) legendLabelB.textContent = getProductLabel('b');

      const rowsAboveInput = document.getElementById('rows-above');
      const rowsBelowInput = document.getElementById('rows-below');
      rowsAboveInput.value = state.rowsAbove;
      rowsBelowInput.value = state.rowsBelow;

      rowsAboveInput.oninput = () => {
        state.rowsAbove = Math.max(1, Number(rowsAboveInput.value || 1));
        renderFigure();
        saveDraft();
      };

      rowsBelowInput.oninput = () => {
        state.rowsBelow = Math.max(1, Number(rowsBelowInput.value || 1));
        renderFigure();
        saveDraft();
      };
    };

    const setCardToggleState = (toggleButton, body, isExpanded) => {
      toggleButton.setAttribute('aria-expanded', String(isExpanded));
      body.hidden = !isExpanded;
      const label = toggleButton.querySelector('.card__toggle-label');
      if (label) {
        label.textContent = isExpanded ? 'Collapse' : 'Expand';
      }
    };

    const setupCardToggles = () => {
      document.querySelectorAll('.card').forEach((card) => {
        const toggleButton = card.querySelector('.card__toggle');
        const body = card.querySelector('.card__body');
        if (!toggleButton || !body) return;
        setCardToggleState(toggleButton, body, true);
        toggleButton.addEventListener('click', () => {
          const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
          setCardToggleState(toggleButton, body, !isExpanded);
        });
      });
    };

    const renderAbove = () => {
      const container = document.getElementById('figure-above');
      container.innerHTML = '';
      const rowsAbove = state.rowsAbove;
      const categories = state.categories.filter((category) => Math.max(category.counts?.above?.a || 0, category.counts?.above?.b || 0) > 0);

      categories.forEach((category) => {
        const column = document.createElement('div');
        column.className = 'figure__column';

        const title = document.createElement('div');
        title.className = 'figure__column-title';
        const label = getCategoryLabel(category);
        title.textContent = label;
        column.appendChild(title);

        const iconGrid = document.createElement('div');
        iconGrid.className = 'figure__icon-grid';
        const iconRows = buildIconRows(category.counts.above, rowsAbove, category, label, true);
        iconRows.forEach((row) => iconGrid.appendChild(row));

        column.appendChild(iconGrid);
        container.appendChild(column);
      });
    };

    const renderBelow = () => {
      const container = document.getElementById('figure-below');
      container.innerHTML = '';
      const rowsBelow = state.rowsBelow;
      const categories = state.categories.filter((category) => Math.max(category.counts?.below?.a || 0, category.counts?.below?.b || 0) > 0);

      categories.forEach((category) => {
        const column = document.createElement('div');
        column.className = 'figure__column';

        const iconGrid = document.createElement('div');
        iconGrid.className = 'figure__icon-grid';
        const label = getCategoryLabel(category);
        const iconRows = buildIconRows(category.counts.below, rowsBelow, category, label, false);
        iconRows.forEach((row) => iconGrid.appendChild(row));

        column.appendChild(iconGrid);

        const title = document.createElement('div');
        title.className = 'figure__column-title';
        title.textContent = label;
        column.appendChild(title);

        container.appendChild(column);
      });
    };

    const renderFigure = () => {
      renderAbove();
      renderBelow();
      saveDraft();
    };

    // FIX: Prefer loading the BUNDLE build for browsers.
    // (The bundle includes the pieces needed for writeFile/download.)
    const pptxScriptSources = [
      'https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.bundle.min.js',
      'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.min.js',
      'https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.min.js',

      // Fallbacks (non-bundle) in case a CDN misbehaves:
      'https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.min.js',
      'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js',
      'https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.min.js'
    ];
    let pptxScriptPromise = null;

    const loadPptxGen = () => {
      if (typeof PptxGenJS !== 'undefined') {
        return Promise.resolve();
      }

      if (pptxScriptPromise) {
        return pptxScriptPromise;
      }

      pptxScriptPromise = new Promise((resolve, reject) => {
        let index = 0;

        const tryNext = () => {
          if (typeof PptxGenJS !== 'undefined') {
            resolve();
            return;
          }

          if (index >= pptxScriptSources.length) {
            reject(new Error('PptxGenJS failed to load.'));
            return;
          }

          const script = document.createElement('script');
          script.src = pptxScriptSources[index];
          script.async = true;
          script.onload = () => {
            if (typeof PptxGenJS !== 'undefined') {
              resolve();
              return;
            }
            index += 1;
            tryNext();
          };
          script.onerror = () => {
            index += 1;
            tryNext();
          };
          document.head.appendChild(script);
        };

        tryNext();
      });

      return pptxScriptPromise;
    };

    const updateExportStatus = (message, detailItems = []) => {
      const exportStatus = document.getElementById('exportStatus');
      const exportMessage = document.getElementById('exportStatusMessage');
      const exportDetails = document.getElementById('exportStatusDetails');
      if (!exportStatus || !exportMessage || !exportDetails) return;
      exportMessage.textContent = message;
      exportDetails.innerHTML = '';
      detailItems.forEach((detail) => {
        const item = document.createElement('li');
        item.textContent = detail;
        exportDetails.appendChild(item);
      });
      exportStatus.querySelector('.export-status__bar')?.setAttribute('aria-valuetext', message);
    };

    const waitForFrame = () => new Promise((resolve) => requestAnimationFrame(resolve));

    const withTimeout = (promise, ms, message) => Promise.race([
      promise,
      new Promise((_, reject) => setTimeout(() => reject(new Error(message)), ms))
    ]);

    const exportToPpt = async () => {
      const exportStatus = document.getElementById('exportStatus');
      const exportButton = document.getElementById('exportPpt');
      exportButton.disabled = true;
      exportButton.textContent = 'Exporting...';
      exportStatus?.classList.add('is-active');

      try {
        updateExportStatus('Loading export toolsâ€¦', ['Fetching the PowerPoint library.']);
        await loadPptxGen();

        // Extra guard: if a non-bundle build loaded and the environment is missing download helpers,
        // fail with a useful error instead of a vague rejection.
        if (typeof PptxGenJS === 'undefined') {
          throw new Error('PptxGenJS is not available after loading.');
        }

        updateExportStatus('Preparing the slideâ€¦', [
          'Initializing the PowerPoint document.',
          'Sizing the slide layout.',
          'Calculating icon positions.'
        ]);
        await waitForFrame();

        updateExportStatus('Building the slide canvasâ€¦', [
          'Creating the presentation object.',
          'Setting slide layout to wide.'
        ]);
        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_WIDE';
        await waitForFrame();

        updateExportStatus('Building the slide canvasâ€¦', [
          'Presentation ready.',
          'Creating a new slide.'
        ]);
        const slide = pptx.addSlide();
        await waitForFrame();

        const titleText = 'Overhead Ratio Visual';
        updateExportStatus('Building the slide canvasâ€¦', [
          'Slide created.',
          `Adding the title (${titleText.length} characters).`,
          'Applying title font and color.'
        ]);
        slide.addText(titleText, { x: 0.6, y: 0.2, w: 12.3, h: 0.4, fontSize: 18, bold: true, color: '1F2933' });

        const slideWidth = 13.3;
        const leftPadding = 0.6;
        const rightPadding = 0.6;
        const usableWidth = slideWidth - leftPadding - rightPadding;
        const aboveCategories = state.categories.filter((category) => Math.max(category.counts?.above?.a || 0, category.counts?.above?.b || 0) > 0);
        const columnWidth = usableWidth / Math.max(1, aboveCategories.length);
        const iconSize = 0.7;
        const iconGap = 0.1;
        const aboveRows = state.rowsAbove;
        const belowRows = state.rowsBelow;
        const lineY = 3.4;
        const aboveBottomPadding = 0.2;
        const belowTopPadding = 0.3;
        const aboveRowHeight = aboveRows * (iconSize + iconGap) - iconGap;
        const aboveIconsTop = lineY - aboveBottomPadding - aboveRowHeight;

        updateExportStatus('Calculating layout metricsâ€¦', [
          `Slide width: ${slideWidth} in.`,
          `Columns: ${aboveCategories.length || 1}.`,
          `Above rows: ${aboveRows}, below rows: ${belowRows}.`
        ]);
        await waitForFrame();

        updateExportStatus('Placing icons above the lineâ€¦', [
          `${aboveCategories.length} categories detected.`,
          `Icon size: ${iconSize} in.`,
          `Gap: ${iconGap} in.`
        ]);
        await waitForFrame();

        for (const [index, category] of aboveCategories.entries()) {
          const columnX = leftPadding + columnWidth * index;
          const label = getCategoryLabel(category);
          const counts = category.counts?.above || { a: 0, b: 0 };
          const slotsA = getSlotCount(counts.a);
          const slotsB = getSlotCount(counts.b);
          const maxSlots = Math.max(slotsA, slotsB);
          const iconsPerRow = Math.max(1, Math.ceil(maxSlots / aboveRows));
          updateExportStatus('Placing icons above the lineâ€¦', [
            `Category ${index + 1} of ${aboveCategories.length}: ${label}.`,
            `Icons above: A ${counts.a}, B ${counts.b}.`,
            `Icons per row: ${iconsPerRow}.`
          ]);
          await waitForFrame();

          slide.addText(label, {
            x: columnX,
            y: 0.8,
            w: columnWidth,
            h: 0.3,
            fontSize: 12,
            align: 'center',
            color: '4B5563'
          });

          for (let i = 0; i < maxSlots; i += 1) {
            const row = aboveRows - 1 - Math.floor(i / iconsPerRow);
            const col = i % iconsPerRow;
            const x = columnX + col * (iconSize + iconGap) + (columnWidth - iconsPerRow * (iconSize + iconGap) + iconGap) / 2;
            const y = aboveIconsTop + row * (iconSize + iconGap);
            const fractionB = getSlotFraction(counts.b, i);
            if (fractionB > 0) {
              slide.addImage({ data: getCategoryIconDataUrl(category, 'b', fractionB), x, y, w: iconSize, h: iconSize });
            }
            const fractionA = getSlotFraction(counts.a, i);
            if (fractionA > 0) {
              slide.addImage({ data: getCategoryIconDataUrl(category, 'a', fractionA), x, y, w: iconSize, h: iconSize });
            }
          }
        }

        updateExportStatus('Drawing the divider lineâ€¦', [
          'Adding the center line.',
          `Divider position: ${lineY} in.`
        ]);
        await waitForFrame();

        slide.addShape(pptx.ShapeType.line, {
          x: leftPadding,
          y: lineY,
          w: usableWidth,
          h: 0,
          line: { color: '111827', width: 2 }
        });

        const belowCategories = state.categories.filter((category) => Math.max(category.counts?.below?.a || 0, category.counts?.below?.b || 0) > 0);
        const belowColumnWidth = usableWidth / Math.max(1, belowCategories.length);

        updateExportStatus('Filtering below-line categoriesâ€¦', [
          `${belowCategories.length} categories below the line.`,
          `Columns below: ${belowCategories.length || 1}.`
        ]);
        await waitForFrame();

        updateExportStatus('Placing icons below the lineâ€¦', [
          `${belowCategories.length} categories below the line.`,
          `Icon size: ${iconSize} in.`,
          `Gap: ${iconGap} in.`
        ]);
        await waitForFrame();

        for (const [index, category] of belowCategories.entries()) {
          const columnX = leftPadding + belowColumnWidth * index;
          const counts = category.counts?.below || { a: 0, b: 0 };
          const slotsA = getSlotCount(counts.a);
          const slotsB = getSlotCount(counts.b);
          const maxSlots = Math.max(slotsA, slotsB);
          const iconsPerRow = Math.max(1, Math.ceil(maxSlots / belowRows));
          updateExportStatus('Placing icons below the lineâ€¦', [
            `Category ${index + 1} of ${belowCategories.length}: ${getCategoryLabel(category)}.`,
            `Icons below: A ${counts.a}, B ${counts.b}.`,
            `Icons per row: ${iconsPerRow}.`
          ]);
          await waitForFrame();

          for (let i = 0; i < maxSlots; i += 1) {
            const row = Math.floor(i / iconsPerRow);
            const col = i % iconsPerRow;
            const x = columnX + col * (iconSize + iconGap) + (belowColumnWidth - iconsPerRow * (iconSize + iconGap) + iconGap) / 2;
            const y = lineY + belowTopPadding + row * (iconSize + iconGap);
            const fractionB = getSlotFraction(counts.b, i);
            if (fractionB > 0) {
              slide.addImage({ data: getCategoryIconDataUrl(category, 'b', fractionB), x, y, w: iconSize, h: iconSize });
            }
            const fractionA = getSlotFraction(counts.a, i);
            if (fractionA > 0) {
              slide.addImage({ data: getCategoryIconDataUrl(category, 'a', fractionA), x, y, w: iconSize, h: iconSize });
            }
          }

          const belowLabelY = lineY + belowTopPadding + belowRows * (iconSize + iconGap) + 0.1;
          slide.addText(getCategoryLabel(category), {
            x: columnX,
            y: belowLabelY,
            w: belowColumnWidth,
            h: 0.3,
            fontSize: 10,
            align: 'center',
            color: '4B5563'
          });
        }

        updateExportStatus('Generating PowerPoint fileâ€¦', ['Packaging slides and assets.', 'This can take a few seconds.']);
        await waitForFrame();

        // writeFile() is the step that used to fail on GitHub Pages when the non-bundle build was loaded.
        await withTimeout(
          pptx.writeFile({ fileName: 'overhead-ratio-visual.pptx' }),
          30000,
          'PowerPoint export timed out.'
        );
      } catch (error) {
        console.error('PowerPoint export failed', error);
        updateExportStatus('Export failed.', [
          `Error: ${error.message || 'Unknown error'}.`,
          'Please try again.',
          'If the issue persists, refresh the page.'
        ]);
        alert('PowerPoint export failed. Please try again.');
      } finally {
        exportButton.disabled = false;
        exportButton.textContent = 'Export to PowerPoint';
        exportStatus?.classList.remove('is-active');
      }
    };

    document.getElementById('exportPpt').addEventListener('click', exportToPpt);
    document.getElementById('add-category').addEventListener('click', () => {
      state.categories.push(normalizeCategory({
        label: 'New Category',
        counts: { above: { a: 0, b: 0 }, below: { a: 0, b: 0 } },
        iconId: iconLibrary[0].id
      }));
      renderControls();
      renderFigure();
      saveDraft();
    });
    document.getElementById('clearDraft').addEventListener('click', () => {
      localStorage.removeItem(draftKey);
      window.location.reload();
    });

    setupCardToggles();
    loadDraft();
    renderControls();
    renderFigure();
  </script>
</body>
</html>
