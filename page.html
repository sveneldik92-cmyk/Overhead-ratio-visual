<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Overhead Ratio Visual Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.min.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <header class="sidebar__header">
        <div>
          <h1>Overhead Ratio Visual Builder</h1>
          <p>Create the ratio graphic with icons above and below the line.</p>
        </div>
        <button class="ghost" id="clearDraft" type="button">Clear Local Draft</button>
      </header>

      <section class="card">
        <h2>Above the Line Counts</h2>
        <p class="card__hint">Choose how many images appear in each category above the line.</p>
        <div class="grid grid--counts" id="counts-above"></div>
        <label class="field">
          <span>Rows (above the line)</span>
          <input type="number" min="1" value="1" id="rows-above">
        </label>
      </section>

      <section class="card">
        <h2>Below the Line Counts</h2>
        <p class="card__hint">Choose how many images appear in each category below the divider.</p>
        <div class="grid grid--counts" id="counts-below"></div>
        <label class="field">
          <span>Rows (below the line)</span>
          <input type="number" min="1" value="2" id="rows-below">
        </label>
      </section>

      <section class="card">
        <div class="card__header">
          <h2>Image Library &amp; Labels</h2>
          <button class="ghost" id="add-category" type="button">Add Label</button>
        </div>
        <p class="card__hint">Upload images and edit labels together. Add or remove categories as needed.</p>
        <div class="grid grid--uploads" id="category-library"></div>
      </section>

      <section class="card">
        <h2>Actions</h2>
        <div class="actions">
          <button id="generate" type="button">Generate Figure</button>
          <button id="exportPpt" class="secondary" type="button">Export to PowerPoint</button>
        </div>
      </section>
    </aside>

    <main class="preview-pane">
      <header class="preview-pane__header">
        <h2>Live Output</h2>
        <p>Aligned layout rendered from your settings.</p>
      </header>
      <section class="figure" id="figure">
        <div class="figure__above" id="figure-above"></div>
        <div class="figure__line"></div>
        <div class="figure__below" id="figure-below"></div>
      </section>
    </main>
  </div>

  <script>
    const defaultSvg = encodeURIComponent(`
      <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
        <rect width="120" height="120" rx="18" fill="#EEF2F7" />
        <path d="M35 70c0-12 10-22 22-22s22 10 22 22" stroke="#B3BCCB" stroke-width="6" fill="none"/>
        <circle cx="57" cy="42" r="14" fill="#B3BCCB"/>
      </svg>
    `);

    const defaultImage = `data:image/svg+xml,${defaultSvg}`;
    const defaultCategories = [
      { id: 'manufacturing-omr', label: 'Manufacturing OMR', counts: { above: 3, below: 0 }, image: defaultImage },
      { id: 'install-omr', label: 'Install OMR', counts: { above: 3, below: 0 }, image: defaultImage },
      { id: 'engineering', label: 'Engineering', counts: { above: 3, below: 0 }, image: defaultImage },
      { id: 'plf', label: 'PL&F', counts: { above: 2, below: 0 }, image: defaultImage },
      { id: 'safety', label: 'Safety', counts: { above: 2, below: 0 }, image: defaultImage },
      { id: 'mfg-install', label: 'Manufacturing & Install Engineers', counts: { above: 0, below: 10 }, image: defaultImage }
    ];

    const state = {
      categories: structuredClone(defaultCategories),
      rowsAbove: 1,
      rowsBelow: 2
    };

    const draftKey = 'overhead-ratio-draft-v1';

    const normalizeCategory = (category) => ({
      id: category.id || `category-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
      label: category.label || 'New Category',
      counts: {
        above: Number(category.counts?.above ?? 0),
        below: Number(category.counts?.below ?? 0)
      },
      image: category.image || defaultImage
    });

    const saveDraft = () => {
      const draft = {
        categories: state.categories,
        rowsAbove: state.rowsAbove,
        rowsBelow: state.rowsBelow
      };
      localStorage.setItem(draftKey, JSON.stringify(draft));
    };

    const loadDraft = () => {
      const raw = localStorage.getItem(draftKey);
      if (!raw) return;
      try {
        const draft = JSON.parse(raw);
        if (draft?.categories?.length) {
          state.categories = draft.categories.map(normalizeCategory);
          state.rowsAbove = Number(draft.rowsAbove ?? 1);
          state.rowsBelow = Number(draft.rowsBelow ?? 2);
          return;
        }

        if (draft?.counts || draft?.labels || draft?.images) {
          const mapped = structuredClone(defaultCategories).map((category) => {
            if (draft?.labels) {
              const labelMap = {
                'manufacturing-omr': draft.labels.manufacturing,
                'install-omr': draft.labels.install,
                engineering: draft.labels.engineering,
                plf: draft.labels.plf,
                safety: draft.labels.safety,
                'mfg-install': draft.labels.below
              };
              category.label = labelMap[category.id] ?? category.label;
            }

            if (draft?.counts) {
              const countMap = {
                'manufacturing-omr': draft.counts.manufacturing,
                'install-omr': draft.counts.install,
                engineering: draft.counts.engineering,
                plf: draft.counts.plf,
                safety: draft.counts.safety,
                'mfg-install': draft.counts.below
              };
              if (category.id === 'mfg-install') {
                category.counts.below = Number(countMap[category.id] ?? category.counts.below);
              } else {
                category.counts.above = Number(countMap[category.id] ?? category.counts.above);
              }
            }

            if (draft?.images) {
              const imageMap = {
                'manufacturing-omr': draft.images.manufacturing,
                'install-omr': draft.images.install,
                engineering: draft.images.engineering,
                plf: draft.images.plf,
                safety: draft.images.safety,
                'mfg-install': draft.images.below
              };
              category.image = imageMap[category.id] ?? category.image;
            }
            return category;
          });

          state.categories = mapped;
          state.rowsAbove = Number(draft.counts?.rowsAbove ?? 1);
          state.rowsBelow = Number(draft.counts?.rowsBelow ?? 2);
        }
      } catch (error) {
        console.warn('Draft load failed', error);
      }
    };

    const createIcon = (src, label) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'icon-card';
      const img = document.createElement('img');
      img.src = src;
      img.alt = label;
      wrapper.appendChild(img);
      return wrapper;
    };

    const getCategoryLabel = (category) => category.label?.trim() || 'Untitled';

    const buildIconRows = (count, rows, iconSrc, label, fillFromBottom) => {
      const safeRows = Math.max(1, rows);
      const iconsPerRow = Math.max(1, Math.ceil(count / safeRows));
      const rowElements = Array.from({ length: safeRows }, () => {
        const row = document.createElement('div');
        row.className = 'figure__icon-row';
        return row;
      });

      for (let i = 0; i < count; i += 1) {
        const baseRow = Math.floor(i / iconsPerRow);
        const rowIndex = fillFromBottom ? safeRows - 1 - baseRow : baseRow;
        rowElements[rowIndex].appendChild(createIcon(iconSrc, label));
      }

      return rowElements;
    };

    const renderCountsSection = (containerId, position) => {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      state.categories.forEach((category) => {
        const field = document.createElement('label');
        field.className = 'field';
        const name = document.createElement('span');
        name.textContent = getCategoryLabel(category);
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.value = category.counts[position] ?? 0;
        input.addEventListener('input', () => {
          category.counts[position] = Number(input.value || 0);
          renderFigure();
          saveDraft();
        });
        field.appendChild(name);
        field.appendChild(input);
        container.appendChild(field);
      });
    };

    const renderCategoryLibrary = () => {
      const container = document.getElementById('category-library');
      container.innerHTML = '';
      const disableRemove = state.categories.length === 1;

      state.categories.forEach((category) => {
        const card = document.createElement('div');
        card.className = 'upload';

        const header = document.createElement('div');
        header.className = 'upload__header';

        const labelInput = document.createElement('input');
        labelInput.type = 'text';
        labelInput.value = category.label;
        labelInput.className = 'upload__label';
        labelInput.addEventListener('input', () => {
          category.label = labelInput.value;
          renderCountsSection('counts-above', 'above');
          renderCountsSection('counts-below', 'below');
          renderFigure();
          saveDraft();
        });

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'ghost ghost--danger';
        removeButton.textContent = 'Remove';
        removeButton.disabled = disableRemove;
        removeButton.addEventListener('click', () => {
          state.categories = state.categories.filter((item) => item.id !== category.id);
          renderControls();
          renderFigure();
          saveDraft();
        });

        header.appendChild(labelInput);
        header.appendChild(removeButton);

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.addEventListener('change', (event) => {
          const file = event.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (loadEvent) => {
            const result = loadEvent.target.result;
            category.image = result;
            preview.style.backgroundImage = `url(${result})`;
            renderFigure();
            saveDraft();
          };
          reader.readAsDataURL(file);
        });

        const preview = document.createElement('div');
        preview.className = 'preview';
        preview.style.backgroundImage = `url(${category.image})`;

        card.appendChild(header);
        card.appendChild(fileInput);
        card.appendChild(preview);
        container.appendChild(card);
      });
    };

    const renderControls = () => {
      renderCountsSection('counts-above', 'above');
      renderCountsSection('counts-below', 'below');
      renderCategoryLibrary();

      const rowsAboveInput = document.getElementById('rows-above');
      const rowsBelowInput = document.getElementById('rows-below');
      rowsAboveInput.value = state.rowsAbove;
      rowsBelowInput.value = state.rowsBelow;

      rowsAboveInput.oninput = () => {
        state.rowsAbove = Math.max(1, Number(rowsAboveInput.value || 1));
        renderFigure();
        saveDraft();
      };

      rowsBelowInput.oninput = () => {
        state.rowsBelow = Math.max(1, Number(rowsBelowInput.value || 1));
        renderFigure();
        saveDraft();
      };
    };

    const renderAbove = () => {
      const container = document.getElementById('figure-above');
      container.innerHTML = '';
      const rowsAbove = state.rowsAbove;

      state.categories.forEach((category) => {
        const column = document.createElement('div');
        column.className = 'figure__column';

        const title = document.createElement('div');
        title.className = 'figure__column-title';
        const label = getCategoryLabel(category);
        title.textContent = label;
        column.appendChild(title);

        const count = Number(category.counts?.above || 0);
        const iconGrid = document.createElement('div');
        iconGrid.className = 'figure__icon-grid';
        const iconRows = buildIconRows(count, rowsAbove, category.image, label, true);
        iconRows.forEach((row) => iconGrid.appendChild(row));

        column.appendChild(iconGrid);
        container.appendChild(column);
      });
    };

    const renderBelow = () => {
      const container = document.getElementById('figure-below');
      container.innerHTML = '';
      const rowsBelow = state.rowsBelow;

      state.categories.forEach((category) => {
        const column = document.createElement('div');
        column.className = 'figure__column';

        const title = document.createElement('div');
        title.className = 'figure__column-title';
        const label = getCategoryLabel(category);
        title.textContent = label;
        column.appendChild(title);

        const count = Number(category.counts?.below || 0);
        const iconGrid = document.createElement('div');
        iconGrid.className = 'figure__icon-grid';
        const iconRows = buildIconRows(count, rowsBelow, category.image, label, false);
        iconRows.forEach((row) => iconGrid.appendChild(row));

        column.appendChild(iconGrid);
        container.appendChild(column);
      });
    };

    const renderFigure = () => {
      renderAbove();
      renderBelow();
      saveDraft();
    };

    const exportToPpt = () => {
      const pptx = new PptxGenJS();
      pptx.layout = 'LAYOUT_WIDE';

      const slide = pptx.addSlide();
      slide.addText('Overhead Ratio Visual', { x: 0.6, y: 0.2, w: 12.3, h: 0.4, fontSize: 18, bold: true, color: '1F2933' });

      const slideWidth = 13.3;
      const leftPadding = 0.6;
      const rightPadding = 0.6;
      const usableWidth = slideWidth - leftPadding - rightPadding;
      const columnWidth = usableWidth / Math.max(1, state.categories.length);
      const iconSize = 0.7;
      const iconGap = 0.1;
      const aboveRows = state.rowsAbove;
      const belowRows = state.rowsBelow;
      const lineY = 3.4;
      const aboveBottomPadding = 0.2;
      const belowTopPadding = 0.3;
      const aboveRowHeight = aboveRows * (iconSize + iconGap) - iconGap;
      const aboveIconsTop = lineY - aboveBottomPadding - aboveRowHeight;

      state.categories.forEach((category, index) => {
        const columnX = leftPadding + columnWidth * index;
        const label = getCategoryLabel(category);
        slide.addText(label, {
          x: columnX,
          y: 0.8,
          w: columnWidth,
          h: 0.3,
          fontSize: 12,
          align: 'center',
          color: '4B5563'
        });

        const count = Number(category.counts?.above || 0);
        const iconsPerRow = Math.max(1, Math.ceil(count / aboveRows));
        for (let i = 0; i < count; i += 1) {
          const row = aboveRows - 1 - Math.floor(i / iconsPerRow);
          const col = i % iconsPerRow;
          const x = columnX + col * (iconSize + iconGap) + (columnWidth - iconsPerRow * (iconSize + iconGap) + iconGap) / 2;
          const y = aboveIconsTop + row * (iconSize + iconGap);
          slide.addImage({ data: category.image, x, y, w: iconSize, h: iconSize });
        }
      });

      slide.addShape(pptx.ShapeType.line, {
        x: leftPadding,
        y: lineY,
        w: usableWidth,
        h: 0,
        line: { color: '111827', width: 2 }
      });

      state.categories.forEach((category, index) => {
        const columnX = leftPadding + columnWidth * index;
        const count = Number(category.counts?.below || 0);
        const iconsPerRow = Math.max(1, Math.ceil(count / belowRows));
        for (let i = 0; i < count; i += 1) {
          const row = Math.floor(i / iconsPerRow);
          const col = i % iconsPerRow;
          const x = columnX + col * (iconSize + iconGap) + (columnWidth - iconsPerRow * (iconSize + iconGap) + iconGap) / 2;
          const y = lineY + belowTopPadding + row * (iconSize + iconGap);
          slide.addImage({ data: category.image, x, y, w: iconSize, h: iconSize });
        }

        const belowLabelY = lineY + belowTopPadding + belowRows * (iconSize + iconGap) + 0.1;
        slide.addText(getCategoryLabel(category), {
          x: columnX,
          y: belowLabelY,
          w: columnWidth,
          h: 0.3,
          fontSize: 10,
          align: 'center',
          color: '4B5563'
        });
      });

      pptx.writeFile({ fileName: 'overhead-ratio-visual.pptx' });
    };

    document.getElementById('generate').addEventListener('click', renderFigure);
    document.getElementById('exportPpt').addEventListener('click', exportToPpt);
    document.getElementById('add-category').addEventListener('click', () => {
      state.categories.push(normalizeCategory({ label: 'New Category', counts: { above: 0, below: 0 }, image: defaultImage }));
      renderControls();
      renderFigure();
      saveDraft();
    });
    document.getElementById('clearDraft').addEventListener('click', () => {
      localStorage.removeItem(draftKey);
      window.location.reload();
    });

    loadDraft();
    renderControls();
    renderFigure();
  </script>
</body>
</html>
